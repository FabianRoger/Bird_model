---
title: "joint Land Use"
output: html_notebook
---

```{r, message = FALSE}
library(sf)
library(raster)
library(dplyr)
library(tidyr)
library(here)
library(readr)
library(readxl)
library(stringr)
library(vegan)
```

### read in LandUse type from different source Raster
```{r}
LandUse_NMD <- readRDS(here("data", "LandUse_NMD_points_500m.Rds"))
LandUse_SJB <- readRDS(here("data", "LandUse_SJB_points_500m.Rds"))
#LandUse_TUVA <- readRDS(here("data", "LandUse_TUVA_points_500m.Rds"))
```

### read in metadata

```{r}
# metadata
NMD <- raster(here("data", "NMD", "nmd2018bas_ogeneraliserad_v1_0.tif")) 
#NMD_pasture <- raster(here("data", "NMD_Tillaggsskikt_Markanvandning", "NMD_markanv_bete_v1.tif"))


# NMD_build_areas <- raster(here("data", "NMD_Tillaggsskikt_Markanvandning", "NMD_markanv_anlagda_omr_v1.tif"))
# NMD_kraft <- raster(here("data", "NMD_Tillaggsskikt_Markanvandning", "NMD_markanv_kraftledning_v1.tif"))

NMD_meta <- 
NMD@data@attributes %>% 
  as.data.frame() %>% 
  dplyr::select(-Opacity, -COUNT) %>% 
  filter(Klass != "") %>% 
  mutate(Klass = iconv(as.character(Klass), "latin1")) %>% 
  rename(NMD_base = ID)

# NMD_pasture_meta <- 
#   NMD_pasture@data@attributes %>% 
#   as.data.frame() %>% 
#   dplyr::select(-Opacity) %>% 
#   filter(Klass != "") %>% 
#   mutate(Klass = iconv(as.character(Klass), "latin1"))

# NMD_build_areas_meta <- 
#   NMD_build_areas@data@attributes %>% 
#   as.data.frame() %>% 
#   dplyr::select(-Opacity) %>% 
#   filter(Klass != "") %>% 
#   mutate(Klass = iconv(as.character(Klass), "latin1")) %>% 
#   rename(Buildings = ID)

# NMD_kraft_meta <- 
#   NMD_kraft@data@attributes %>% 
#   as.data.frame() %>% 
#   dplyr::select(-Opacity) %>% 
#   filter(Klass != "") %>% 
#   mutate(Klass = iconv(as.character(Klass), "latin1"))

```


### regroup cropdata to groups

```{r}
SJB_meta <- 
  read_xlsx(here("data", "crop_codes_english.xlsx")) %>% 
  rename(Landuse_code = `Landuse code`) %>% 
  dplyr::select(Landuse_code, English) %>% 
  distinct() %>% 
  group_by(Landuse_code) %>% 
  filter(row_number()==n()) #this selects the most recent definition of the crop_code if they have been redifined over the years. However, the meaning of the crop code doesn't change substantially in most cases and in no major case
 
LandUse_SJB_filt <- 
LandUse_SJB %>% 
  filter(apply(dplyr::select(., starts_with("SJB")), 1, function(x) all(!is.na(x))))

# n_max maximum prct of LandUse in any Buffer in any route in any year
# n_mean average prct of LandUse among Buffer were LandUse occures
# occurence_prct proportion of Buffer with LandUse

LandUse_SJB_max <- 
LandUse_SJB_filt %>% 
  dplyr::select(karta, position, starts_with("SJB")) %>% 
  gather(year, Landuse_code, -karta, -position) %>% 
  group_by(year, karta, position, Landuse_code) %>% 
  summarize(n = n()) %>%
  mutate(n = round(100*n/7853, 2)) %>% 
  group_by(Landuse_code) %>% 
  summarize(max_use_prct = max(n),
            mean_use_prct = round(mean(n),2),
            occurence_prct = round(100*(n()/46336),2)) %>% #724 routes * 8 points * 8 years
  arrange(desc(max_use_prct)) 

#LandUse_SJB_max <- 
LandUse_SJB_max %>%
  full_join(SJB_meta) 

LandUse_SJB_max %>% 
  mutate(English = str_trunc(English, 25, "right"))

# export LandUse codes for regrouping
# write_csv2(LandUse_SJB_max, here("data", "CropCodes.csv"))

```

#### recode

```{r}

LandUse_SJB_groups <- 
  read_csv2(here("data", "CropCodes.csv"))

LandUse_SJB_groups <-
  LandUse_SJB_groups %>% 
  mutate(crop_groups = case_when(
    Landuse_code %in% c(52,54,55,56,89,95,96) ~ "Pasture",
    Landuse_code %in% c(49,50,51,53,57,58,59,80,81) ~ "Ley",
    Landuse_code %in% c(1,3,4,7,8,12,20,22) ~ "Winter_cereal",
    Landuse_code %in% c(2,5,9,21,23,30,31) ~ "Spring_cereal",
    Landuse_code %in% c(60,62,69) ~ "Fallow",
    Landuse_code %in% c(46,47,32,35) ~ "Tuber_Root", #45? <- add 
    Landuse_code %in% c(65,67,68) ~ "Woody_crops",
    TRUE ~ "Other"))

LandUse_SJB_groups %>% 
  mutate(English = str_trunc(English, 25, "right")) %>% 
  arrange(crop_groups)

LandUse_SJB_rec <- 
  LandUse_SJB %>% 
  mutate_at(vars(starts_with("SJB_")), function(x) {
    LandUse_SJB_groups[ match( x, LandUse_SJB_groups$Landuse_code),]$crop_groups
  })

Crop_rotations <- 
LandUse_SJB_rec %>% 
  filter_at( vars(starts_with("SJB_")), function(x) !is.na(x)) %>% 
  select(starts_with("SJB")) %>%  
  group_by_all() %>% 
  summarize(n = n()) %>% 
  ungroup %>% 
  mutate(n_prct = round(n/sum(n), 4)*100) %>% 
  arrange(desc(n)) %>% 
  mutate_at(vars(starts_with("SJB")), function(x) (str_trunc(x, 15, "right")))

Crop_rotations
```

```{r}
Crop_rotations %>% 
  mutate(combo = 1:n()) %>% 
  gather(year, crop, -n, -n_prct, -combo) %>% 
  group_by(combo) %>% 
  summarize(div = exp(diversity(table(as.numeric(as.factor(crop))))),
            N_comb = length(unique(crop)),
            n = unique(n)) %>%  
  group_by(div) %>% 
  summarize(N_comb = unique(N_comb),
            n_combo = n(),
            n = sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(n_prct = round(n/sum(n), 4)*100)
```


## recode Landuse classes from NMD
-> we do not distinguish between forest on wetlan and forest on dryland
-> we do not distinguish between 
51  Exploaterad mark, byggnad		
52	Exploaterad mark, ej byggnad eller väg/järnväg		
53	Exploaterad mark, väg/järnväg

### NMD bassikt

```{r}

LandUse_NMD_rec <- 
LandUse_NMD %>% 
  mutate(NMD_base = case_when(
    NMD_base %in%  c(121:128) ~ NMD_base - 10,
    NMD_base %in%  c(52,53) ~ 51,
    TRUE ~ NMD_base))
  
LandUse_NMD_rec %>% 
  dplyr::select(karta, position, NMD_base) %>% 
  group_by(karta, position, NMD_base) %>% 
  summarize(n = n()) %>%
  mutate(n = round(100*n/7853, 2)) %>% 
  group_by(NMD_base) %>% 
  summarize(max_use_prct = max(n),
            mean_use_prct = round(mean(n),2),
            occurence_prct = round(100*(n()/5792),2)) %>%  #724 routes * 8 points
  arrange(desc(occurence_prct)) %>%
  left_join(NMD_meta) %>% 
  select(1,5,2:4) %>% 
  mutate(Klass = str_trunc(Klass, 25, "right")) %>% 
  arrange(NMD_base)

```

## join SJB data to NMD data

```{r}
LandUse_joint <- 
  cbind(LandUse_NMD_rec, select(LandUse_SJB_rec, starts_with("SJB")))

         
```

+ NMDbase landuse class `3 (Åkermark)` is filled in by data from SJB
+ `Pasture` is dropped in favor of SJB
+ SJB Landuse class `Woody_crops` is replaced by class `115	Triviallövskog (utanför våtmark)`
+ `Buildings` and `Powerlines` are dropped


## drop columns
```{r}

LandUse_joint <- 
LandUse_joint %>% 
  select(-Pasture, -Buildings, -Powerlines)
  
```

## recode SJB to numeric

```{r}
LandUse_meta <- 
  tibble(LandUse = na.omit(unique(LandUse_SJB_rec$SJB_2012))) %>% 
  mutate(LandUse_code = 300+1:n())

LandUse_meta <- 
NMD_meta %>% 
  filter(NMD_base %in% unique(LandUse_NMD_rec$NMD_base)) %>% 
  rename(LandUse = Klass,
         LandUse_code = NMD_base) %>% 
  bind_rows(LandUse_meta)

LandUse_meta <- 
LandUse_meta %>% 
  mutate(LandUse = gsub("(\\w+)\\s\\(utanför våtmark\\)", "\\1", LandUse),
         LandUse = gsub("(\\w+), byggnad", "\\1", LandUse),
         LandUse = gsub("\\s", "_", LandUse))

LandUse_meta
```

```{r}

LandUse_joint <- 
  LandUse_joint %>% 
  mutate_at(vars(starts_with("SJB")), function(x) LandUse_meta$LandUse_code[match(x, LandUse_meta$LandUse)])


filter(LandUse_joint, NMD_base == 3)
```

## recode columns for all years

```{r}

LandUse_joint <- 
  LandUse_joint %>% 
  mutate_at(vars(starts_with("SJB")),
            funs(case_when(is.na(.) ~ NMD_base,
                           . == 308 ~ 115,
                           TRUE ~ .)))
            


filter(LandUse_joint, NMD_base == 3)

prct_3 <- 
LandUse_joint %>% 
  group_by(karta, position) %>% 
  summarise_at(vars(starts_with("SJB")), function(x) sum(x == 3)/n())

prct_3 %>% 
  ungroup() %>% 
  filter(SJB_2012 == max(SJB_2012))

apply(prct_3[,3:ncol(prct_3)], 2, function(x) quantile(x, seq(0.9,1,0.01)))*100

```

Not all pixel that are coded `3 Åkermark`in the NMD are covered by the SJB. It's seldom much (see % in each circle above, never more than 5% of total area in 99% of cases), but we need to deal with it. 

we declare the remaining `Åkermark` as `Övrig_öppen_mark_med_vegetation`. 

```{r}
LandUse_joint <- 
LandUse_joint %>% 
  mutate_at(vars(starts_with("SJB")), funs(
    case_when(. == 3 ~ 42,
              TRUE ~ .)))

LandUse_joint_sum <- 
LandUse_joint %>% 
  select(-NMD_base, -cells) %>% 
  gather(year, LandUse_code, -karta, -position) %>% 
  group_by(karta, position, LandUse_code, year) %>% 
  summarize(m2 = n()*100)

 
```



```{r}
LandUse_joint_sum <- 
LandUse_joint_sum %>%
  ungroup() %>% 
  mutate(LandUse = LandUse_meta[match(LandUse_joint_sum$LandUse_code,                                   LandUse_meta$LandUse_code),]$LandUse)

LandUse_joint_sum %>% 
  select(-LandUse_code) %>% 
  spread(LandUse, m2, fill = 0)

```

LandUse code 0 is for pixel outside NMD. I need to deal with them.

```{r}
Routes_not_covered <- 
LandUse_joint_sum %>% 
  ungroup() %>% 
  group_by(karta, position) %>% 
  summarise(Excl = TRUE %in% is.na(LandUse)) %>% #pixels outside NMD in buffer?
  group_by(karta) %>% 
  filter(TRUE %in% Excl) %>% 
  mutate(N_Excl = sum(Excl))

Routes_not_covered %>%
  summarise(N_Excl = sum(Excl)) 
  

```

I exclude all routes which have >= 4 points that are not fully covered by the NMD. 
For the remaining routes I exclude only the buffers with missing data.

```{r}

LandUse_joint_sum <- 
LandUse_joint_sum %>%  
  filter( !karta %in% filter(Routes_not_covered, N_Excl >= 4)$karta) %>% 
  filter( !paste(karta, position) %in% 
            paste(filter(Routes_not_covered, N_Excl <4 & Excl)$karta,
                  filter(Routes_not_covered, N_Excl <4 & Excl)$position)) 

```


```{r}

LandUse_wide <-
  LandUse_joint_sum %>% 
  select(-LandUse_code) %>% 
  spread(LandUse, m2, fill = 0) 
  
```


```{r}
write_csv(LandUse_wide, here("data", "LandUse_joint.csv"))
```


